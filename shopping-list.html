
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shopping List â€“ Pantry Inventory Management</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- 1) Supabase JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <!-- 2) Your Supabase config (must set window.supabase) -->
  <script src="supabase-config.js"></script>
  <!-- 3) Your common utilities (checkAuth, showModal, hideModal, showAlert, formatDate, handleLogout) -->
  <script src="app.js"></script>
</head>
<body>
  <nav class="navbar">
    <ul class="nav-list">
      <li><a href="dashboard.html">Dashboard</a></li>
      <li><a href="pantry.html">Pantry</a></li>
      <li><a href="shopping-list.html" class="active">Shopping List</a></li>
      <li><a href="#" class="logout-btn">Logout</a></li>
    </ul>
  </nav>

  <div class="container">
    <div class="text-center mt-2">
      <h1>Shopping Lists</h1>
      <div class="mt-2">
        <button class="btn btn-primary" onclick="generateShoppingList()">Generate New List</button>
        <button class="btn btn-primary" onclick="showModal('createListModal')">Create Custom List</button>
      </div>
    </div>

    <div class="mt-2">
      <div class="form-group">
        <input type="text" id="searchInput" class="form-control" placeholder="Search lists or items...">
      </div>

      <div id="shoppingLists">
        <!-- Lists rendered here -->
      </div>
    </div>
  </div>

  <!-- Create Custom List Modal -->
  <div id="createListModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Create Custom Shopping List</h2>
      <form id="createListForm">
        <div class="form-group">
          <label for="listName">List Name</label>
          <input type="text" id="listName" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="listItems">Items (one per line)</label>
          <textarea id="listItems" class="form-control" rows="5" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Create List</button>
      </form>
    </div>
  </div>

  <!-- View List Modal -->
  <div id="viewListModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 id="viewListTitle">Shopping List</h2>
      <div id="viewListItems"></div>
      <div class="mt-2">
        <button class="btn btn-primary" onclick="printList()">Print List</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      await checkAuth();
      const { data: { session } } = await supabase.auth.getSession();
      const user = session.user;

      let shoppingLists = [];

      // Load all lists for this user
      async function loadLists() {
        const { data, error } = await supabase
          .from('shopping_lists')
          .select('list_id, name, items, creation_date')
          .eq('uid', user.id)
          .order('creation_date', { ascending: false });
        if (error) {
          return showAlert('Error loading lists: ' + error.message, 'danger');
        }
        shoppingLists = data.map(l => ({
          id: l.list_id,
          name: l.name,
          items: l.items,           // JSON array of strings
          date: l.creation_date     // ISO timestamp
        }));
        displayLists(shoppingLists);
      }

      // Render a list of lists
      function displayLists(lists) {
        const container = document.getElementById('shoppingLists');
        container.innerHTML = '';
        lists.forEach(list => {
          const div = document.createElement('div');
          div.className = 'card';
          div.style.marginBottom = '1rem';
          div.innerHTML = `
            <div style="padding:1rem;">
              <h3>${list.name}</h3>
              <p>Created: ${formatDate(list.date)}</p>
              <p>Items: ${list.items.length}</p>
              <div class="mt-2">
                <button class="btn btn-primary" onclick="viewList(${list.id})">View</button>
                <button class="btn btn-danger" onclick="deleteList(${list.id})">Delete</button>
              </div>
            </div>`;
          container.appendChild(div);
        });
      }

      // Generate automatic list from low-stock or expiring items
      async function generateShoppingList() {
        // Fetch items where quantity=0 OR expiration_date <= today
        const today = new Date().toISOString().split('T')[0];
        const { data: lowItems, error: err } = await supabase
          .from('pantry_items')
          .select('name')
          .eq('uid', user.id)
          .or(`quantity.eq.0,expiration_date.lte.${today}`);
        if (err) {
          return showAlert('Error generating list: ' + err.message, 'danger');
        }
        const itemNames = lowItems.map(i => i.name);
        // Save the new list
        const { error: saveErr } = await supabase
          .from('shopping_lists')
          .insert([{
            uid: user.id,
            name: 'Auto-generated List',
            items: itemNames,
            creation_date: new Date().toISOString()
          }]);
        if (saveErr) {
          return showAlert('Error saving generated list: ' + saveErr.message, 'danger');
        }
        showAlert('Shopping list generated successfully');
        loadLists();
      }

      // Handle custom list creation
      document.getElementById('createListForm').onsubmit = async e => {
        e.preventDefault();
        const name = document.getElementById('listName').value.trim();
        const items = document.getElementById('listItems').value
          .split('\n').map(s=>s.trim()).filter(Boolean);
        const { error } = await supabase
          .from('shopping_lists')
          .insert([{
            uid: user.id,
            name,
            items,
            creation_date: new Date().toISOString()
          }]);
        if (error) return showAlert('Error creating list: ' + error.message, 'danger');
        hideModal('createListModal');
        showAlert('Shopping list created successfully');
        loadLists();
      };

      // View list details
      window.viewList = id => {
        const list = shoppingLists.find(l => l.id === id);
        if (!list) return;
        document.getElementById('viewListTitle').textContent = list.name;
        document.getElementById('viewListItems').innerHTML = `
          <p>Created: ${formatDate(list.date)}</p>
          <ul style="list-style:none;padding:0;">
            ${list.items.map(item => `<li style="padding:0.5rem 0;border-bottom:1px solid var(--border-color);">${item}</li>`).join('')}
          </ul>`;
        showModal('viewListModal');
      };

      // Delete a list
      window.deleteList = async id => {
        if (!confirm('Are you sure you want to delete this list?')) return;
        const { error } = await supabase
          .from('shopping_lists')
          .delete()
          .eq('list_id', id);
        if (error) return showAlert('Error deleting list: ' + error.message, 'danger');
        showAlert('List deleted successfully');
        loadLists();
      };

      // Print the currently viewed list
      window.printList = () => {
        const html = document.getElementById('viewListModal').querySelector('.modal-content').innerHTML;
        const w = window.open('', '_blank');
        w.document.write(`<html><head><title>${document.getElementById('viewListTitle').textContent}</title></head><body>${html}</body></html>`);
        w.document.close();
        w.print();
      };

      // Search filter
      document.getElementById('searchInput').addEventListener('input', e => {
        const q = e.target.value.toLowerCase();
        displayLists(shoppingLists.filter(l =>
          l.name.toLowerCase().includes(q) ||
          l.items.some(item => item.toLowerCase().includes(q))
        ));
      });

      // Kick it off
      loadLists();
    });
  </script>
</body>
</html>
